<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top-100 HipHop Music</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #fcfcfc; --ink-color: #000; --youtube-color: #FF5722; --link-color: #1976D2; --font-main: 'Inter', sans-serif; }
        body {
            font-family: var(--font-main); background-color: #FAF0E6; 
            background-image: url('./0.jpg'); background-size: cover; background-position: center; background-attachment: fixed;
            display: flex; justify-content: center; padding: 20px; margin: 0; padding-bottom: 100px; position: relative;
        }
        .side-gallery { position: fixed; top: 20px; bottom: 20px; width: calc(50vw - 360px); display: flex; flex-direction: column; justify-content: space-around; align-items: center; pointer-events: none; z-index: -1; overflow: hidden; }
        #left-gallery { left: 0; } #right-gallery { right: 0; }
        .gallery-img { max-width: 80%; max-height: 22vh; object-fit: cover; border: 6px solid white; border-bottom: 20px solid white; box-shadow: 5px 5px 15px rgba(0,0,0,0.15); border-radius: 2px; animation: gentleSwing 4s ease-in-out infinite; }
        @keyframes gentleSwing { 0% { transform: rotate(calc(var(--base-angle) - 3deg)); } 50% { transform: rotate(calc(var(--base-angle) + 3deg)); } 100% { transform: rotate(calc(var(--base-angle) - 3deg)); } }
        
        .paper { width: 100%; max-width: 650px; background: var(--bg-color); border: 3px solid var(--ink-color); border-radius: 2px 5px 3px 6px; padding: 30px; box-shadow: 10px 10px 0px rgba(0,0,0,0.1); position: relative; min-height: 80vh; margin-top: 20px; z-index: 10; }
        header { text-align: center; margin-bottom: 30px; font-size: 2.5rem; position: relative; }
        .star-icon { font-size: 3rem; position: absolute; top: -10px; left: 10px; transform: rotate(-15deg); }
        .title-text { border-bottom: 2px solid var(--ink-color); padding-bottom: 5px; display: inline-block; font-family: var(--font-main); font-weight: 800; letter-spacing: 1px; }
        
        #stats-btn { position: absolute; right: 0; top: 100%; margin-top: 10px; background: white; color: #FF7043; border: 2px solid #FF7043; padding: 6px 10px; font-size: 1rem; border-radius: 4px; white-space: nowrap; line-height: 1; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
        
        #song-list { list-style: none; padding: 0; margin: 0; }
        .song-item { display: flex; align-items: center; font-size: 1.5rem; margin-bottom: 15px; padding: 8px 5px; background: white; border-bottom: 1px dashed #ddd; justify-content: space-between; }
        .song-item:hover { background: #fffbe6; }
        .left-content { display: flex; align-items: baseline; flex-grow: 1; overflow: hidden; padding-right: 10px; }
        
        /* ÈöêËóèÊãñÊãΩÁÇπ */
        .rank-num { width: 45px; font-weight: 800; flex-shrink: 0; margin-right: 10px; }
        .song-name { font-weight: 700; line-height: 1.2; margin-right: 15px; white-space: nowrap; }
        .artist-name { color: #666; font-size: 1.2rem; white-space: nowrap; }
        .right-controls { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .link-trigger { font-size: 1.1rem; cursor: pointer; padding: 2px 8px; text-align: center; line-height: 1.2; font-weight: 700; }
        .link-trigger.youtube { color: var(--youtube-color); border: 2px solid var(--youtube-color); border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; transform: rotate(-2deg); display: inline-block; }
        .link-trigger.youtube:hover { background: var(--youtube-color); color: white; }
        .link-trigger.generic { color: var(--link-color); text-decoration: underline; }
        .link-trigger.generic:hover { color: darkblue; }

        .popup-window { position: fixed; background: white; border: 3px solid black; box-shadow: 8px 8px 0px rgba(0,0,0,0.2); display: none; flex-direction: column; border-radius: 4px; resize: both; overflow: hidden; font-family: var(--font-main); }
        .popup-header { background: black; color: white; padding: 8px 10px; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; flex-shrink: 0; cursor: move; font-weight: 700; }
        .close-popup { background: red; color: white; border: 1px solid white; cursor: pointer; font-family: var(--font-main); font-weight: bold; }
        #player-popup { top: 80px; left: 20px; width: 430px; height: 380px; z-index: 2000; min-width: 280px; min-height: 180px; }
        iframe#web-frame { width: 100%; height: 100%; flex-grow: 1; border: none; background: #000; }
        #stats-popup { top: 80px; right: 40px; width: 380px; height: 520px; z-index: 2001; min-width: 250px; min-height: 200px; background: #fafafa; }
        .stats-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
    </style>
</head>
<body>
    <div id="left-gallery" class="side-gallery"></div>
    <div class="paper">
        <header>
            <div class="star-icon">‚òÜ</div>
            <div class="title-text">Top 100 HipHop Songs</div>
            <button id="stats-btn">Statistics</button>
        </header>
        <ul id="song-list"></ul>
    </div>
    <div id="right-gallery" class="side-gallery"></div>

    <div class="popup-window" id="player-popup">
        <div class="popup-header" id="player-header">
            <span id="player-title">Player</span>
            <button class="close-popup" onclick="closePlayer()">X</button>
        </div>
        <iframe id="web-frame" src="" sandbox="allow-scripts allow-same-origin allow-popups allow-presentation" referrerpolicy="no-referrer-when-downgrade" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>

    <div class="popup-window" id="stats-popup">
        <div class="popup-header" id="stats-header">
            <span>üåü Singer Ranking Statistics</span>
            <button class="close-popup" onclick="closeStats()">X</button>
        </div>
        <div class="stats-content" id="stats-content"></div>
    </div>

    <script src="./data.js"></script>

    <script>
        function loadSideGalleries() {
            const leftGallery = document.getElementById('left-gallery');
            const rightGallery = document.getElementById('right-gallery');
            for (let i = 1; i <= 8; i++) {
                const img = document.createElement('img');
                img.className = 'gallery-img';
                img.src = `./images/${i}.jpg`; 
                const randomAngle = Math.floor(Math.random() * 20) - 10;
                img.style.setProperty('--base-angle', `${randomAngle}deg`);
                const randomDelay = Math.random() * 4; 
                img.style.animationDelay = `-${randomDelay}s`; 
                img.onerror = function() { this.style.display = 'none'; };
                if (i % 2 !== 0) { leftGallery.appendChild(img); } else { rightGallery.appendChild(img); }
            }
        }
        loadSideGalleries();

        // Ê†∏ÂøÉÔºöÁõ¥Êé•‰ΩøÁî® data.js ÈáåÁöÑ mySongs ÂèòÈáèÔºå‰∏çÂÜç‰ΩøÁî® localStorage
        let songs = typeof mySongs !== 'undefined' ? mySongs : [];

        const listEl = document.getElementById('song-list');
        const playerPopup = document.getElementById('player-popup');
        const webFrame = document.getElementById('web-frame');
        const playerTitle = document.getElementById('player-title');
        const statsPopup = document.getElementById('stats-popup');
        const statsContent = document.getElementById('stats-content');

        function renderList() {
            listEl.innerHTML = '';
            songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'song-item';

                const leftContent = document.createElement('div');
                leftContent.className = 'left-content';

                const rankSpan = document.createElement('span');
                rankSpan.className = 'rank-num';
                rankSpan.textContent = (index + 1) + '.'; 

                const nameSpan = document.createElement('span');
                nameSpan.className = 'song-name';
                nameSpan.textContent = song.name;

                const artistSpan = document.createElement('span');
                artistSpan.className = 'artist-name';
                artistSpan.textContent = song.artist;

                leftContent.appendChild(rankSpan);
                leftContent.appendChild(nameSpan);
                leftContent.appendChild(artistSpan);

                const rightControls = document.createElement('div');
                rightControls.className = 'right-controls';

                if (song.url) {
                    const linkTrigger = document.createElement('span');
                    const isYoutube = isYoutubeLink(song.url);
                    if (isYoutube) {
                        linkTrigger.textContent = 'YouTube';
                        linkTrigger.className = 'link-trigger youtube';
                    } else {
                        linkTrigger.textContent = 'Link';
                        linkTrigger.className = 'link-trigger generic';
                    }
                    linkTrigger.onclick = function() { playSong(index); };
                    rightControls.appendChild(linkTrigger);
                }

                li.appendChild(leftContent);
                li.appendChild(rightControls);
                listEl.appendChild(li);
            });
            
            if (statsPopup.style.display === 'flex') { generateStats(); }
        }

        function isYoutubeLink(url) {
            if (!url) return false;
            return /youtube\.com|youtu\.be/.test(url);
        }

        function getYoutubeEmbed(url) {
            const regExp = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regExp);
            if (match && match[1]) { return `https://www.youtube.com/embed/${match[1]}?autoplay=1&modestbranding=1&rel=0`; } 
            else { return url; }
        }

        function playSong(index) {
            const song = songs[index];
            if (!song.url) return;
            playerPopup.style.display = 'flex';
            playerTitle.textContent = song.name;
            if (isYoutubeLink(song.url)) { webFrame.src = getYoutubeEmbed(song.url); } 
            else { webFrame.src = song.url; }
        }

        window.closePlayer = function() { playerPopup.style.display = 'none'; webFrame.src = ''; }

        document.getElementById('stats-btn').addEventListener('click', () => { generateStats(); statsPopup.style.display = 'flex'; });
        window.closeStats = function() { statsPopup.style.display = 'none'; }

        function generateStats() {
            let artistStats = {};
            songs.forEach((song, index) => {
                const rank = index + 1;
                let points = Math.round(50 + (100 - rank) / 2);
                if (song.artist) {
                    let artists = song.artist.split('/').map(a => a.trim()).filter(a => a !== '');
                    let splitPoints = points / artists.length;
                    artists.forEach(artist => {
                        if (artist.toLowerCase() === 'higher') {
                            let mScore = splitPoints * 0.6;
                            if (!artistStats['È©¨ÊÄùÁª¥']) artistStats['È©¨ÊÄùÁª¥'] = { totalScore: 0, songs: [] };
                            artistStats['È©¨ÊÄùÁª¥'].totalScore += mScore; artistStats['È©¨ÊÄùÁª¥'].songs.push({ name: song.name, score: mScore });
                            let kScore = splitPoints * 0.4;
                            if (!artistStats['KnowKnow']) artistStats['KnowKnow'] = { totalScore: 0, songs: [] };
                            artistStats['KnowKnow'].totalScore += kScore; artistStats['KnowKnow'].songs.push({ name: song.name, score: kScore });
                        } else {
                            if (!artistStats[artist]) artistStats[artist] = { totalScore: 0, songs: [] };
                            artistStats[artist].totalScore += splitPoints; artistStats[artist].songs.push({ name: song.name, score: splitPoints });
                        }
                    });
                }
            });

            let sortedArtists = Object.keys(artistStats).map(name => {
                return { 
                    name: name, totalScore: Math.round(artistStats[name].totalScore * 10) / 10,
                    songs: artistStats[name].songs.map(s => ({ name: s.name, score: Math.round(s.score * 10) / 10 })).sort((a, b) => b.score - a.score)
                }; 
            }).sort((a, b) => b.totalScore - a.totalScore); 

            statsContent.innerHTML = '';
            if (sortedArtists.length === 0) { statsContent.innerHTML = '<p style="text-align:center; color:#888;">ÊöÇÊó†Êï∞ÊçÆ</p>'; return; }

            sortedArtists.forEach((artistData, index) => {
                let medal = `${index + 1}.`;
                const row = document.createElement('div');
                row.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 1.2rem; cursor: pointer;";
                row.innerHTML = `
                    <span class="rank-medal" style="font-weight: 800; color: #FF5722; width: 30px;">${medal}</span>
                    <span class="artist-name-stat" style="flex-grow: 1; font-weight: 700; user-select: none;">
                        ${artistData.name} <span style="color: #aaa; font-size: 0.85em; font-weight: normal; margin-left: 4px;">(${artistData.songs.length})</span>
                        <span class="arrow" style="font-size: 0.8em; color: #bbb; margin-left: 5px; transition: 0.2s;">‚ñ∂</span>
                    </span>
                    <span class="score" style="font-weight: 800; color: #1976D2;">${artistData.totalScore} ÂàÜ</span>
                `;
                const detailsDiv = document.createElement('div');
                detailsDiv.style.cssText = "display: none; flex-direction: column; background: #f5f5f5; padding: 10px 15px; border-bottom: 1px solid #ddd; font-size: 0.95rem; color: #555; border-radius: 4px; margin-bottom: 5px;";
                artistData.songs.forEach((song, sIdx) => {
                    const songRow = document.createElement('div');
                    songRow.style.cssText = "display: flex; justify-content: space-between; padding: 4px 0;";
                    songRow.innerHTML = `<span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%;">${sIdx + 1}. ${song.name}</span><span style="font-weight: 600; color: #888;">+${song.score}</span>`;
                    detailsDiv.appendChild(songRow);
                });
                row.onclick = function() {
                    const arrow = row.querySelector('.arrow');
                    if (detailsDiv.style.display === 'none') { detailsDiv.style.display = 'flex'; arrow.textContent = '‚ñº'; arrow.style.color = '#FF5722'; } 
                    else { detailsDiv.style.display = 'none'; arrow.textContent = '‚ñ∂'; arrow.style.color = '#bbb'; }
                };
                statsContent.appendChild(row); statsContent.appendChild(detailsDiv);
            });
        }

        makeDraggable(playerPopup, document.getElementById('player-header'));
        makeDraggable(statsPopup, document.getElementById('stats-header'));

        function makeDraggable(elmnt, header) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            header.onmousedown = dragMouseDown;
            function dragMouseDown(e) { e = e || window.event; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
            function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }

        renderList();
    </script>
</body>

</html>
